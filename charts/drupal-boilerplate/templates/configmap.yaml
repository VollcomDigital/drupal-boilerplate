apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "drupal-boilerplate.fullname" . }}-config
  labels:
    {{- include "drupal-boilerplate.labels" . | nindent 4 }}
data:
  APP_ENV: {{ .Values.env.appEnv | quote }}
  DRUPAL_ENV: {{ .Values.env.drupalEnv | quote }}
  DRUPAL_TRUSTED_HOST_PATTERNS: {{ .Values.env.trustedHostPatterns | quote }}
  DRUPAL_REVERSE_PROXY: {{ ternary "true" "false" .Values.env.reverseProxy | quote }}
  DRUPAL_REVERSE_PROXY_ADDRESSES: {{ .Values.env.reverseProxyAddresses | quote }}
  DRUPAL_DISABLE_POORMANS_CRON: {{ ternary "true" "false" .Values.env.disablePoormansCron | quote }}
  DRUPAL_CONFIG_SYNC_DIRECTORY: {{ .Values.env.configSyncDirectory | quote }}
  DRUPAL_PRIVATE_FILES_PATH: {{ .Values.env.privateFilesPath | quote }}
  DRUPAL_FILES_DRIVER: {{ .Values.env.filesDriver | quote }}
  DB_DRIVER: {{ .Values.env.dbDriver | quote }}
  DB_HOST: {{ .Values.env.dbHost | quote }}
  DB_PORT: {{ .Values.env.dbPort | quote }}
  DB_NAME: {{ .Values.env.dbName | quote }}
  DB_USER: {{ .Values.env.dbUser | quote }}
  REDIS_HOST: {{ .Values.env.redisHost | quote }}
  REDIS_PORT: {{ .Values.env.redisPort | quote }}
  REDIS_PREFIX: {{ .Values.env.redisPrefix | quote }}
  S3_BUCKET: {{ .Values.env.s3.bucket | quote }}
  S3_REGION: {{ .Values.env.s3.region | quote }}
  S3_ENDPOINT: {{ .Values.env.s3.endpoint | quote }}
  S3_PUBLIC_BASE_URL: {{ .Values.env.s3.publicBaseUrl | quote }}
  S3_USE_PATH_STYLE_ENDPOINT: {{ ternary "true" "false" .Values.env.s3.usePathStyleEndpoint | quote }}
  nginx.conf: |
    server {
      listen 8080;
      server_name _;
      root /var/www/html/web;
      index index.php;

      server_tokens off;
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;

      location / {
        try_files $uri /index.php?$query_string;
      }

      location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_PROXY "";
        fastcgi_read_timeout 300;
      }

      location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|ico|woff|woff2)$ {
        expires 1h;
        add_header Cache-Control "public";
        try_files $uri /index.php?$query_string;
      }

      location ~ /\.(?!well-known).* {
        deny all;
      }
    }
